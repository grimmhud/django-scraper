<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Scraper</title>
</head>

<body>
    <div class="container" style="margin-top: 30px;">
        <h3>Web Scraping</h3>
        <form action="/" method="POST">
            <div style="margin-top: 20px;">
                <div>
                    <label for="website-input" class="form-label">Website URL:</label>
                    <input name="website" type="text" id="website-input" class="form-control"
                        aria-describedby="website-input-helper">
                    <div id="path-input-helper" class="form-text">
                        Write the exact website url.
                    </div>
                </div>

                <div>
                    <label for="path-input" class="form-label">Path:</label>
                    <input name="path" type="text" id="path-input" class="form-control"
                        aria-describedby="path-input-helper">
                    <div id="path-input-helper" class="form-text">
                        Write the full Path to extract the data.
                    </div>
                </div>
            </div>
            {% csrf_token %}
            <input id="scraping-submit" type="submit" class="btn btn-primary" value="Extract"
                style="margin-top: 5px;" />
        </form>
    </div>
    {% if extracted_data %}
    <div class="container" style="margin-top: 40px;">
        <p class="h4">Extracted Data</p>
        <div>
            <select id="select-export-file" name="file_type" class="form-select form-select-sm"
                aria-label=".form-select-sm example">
                <option selected>Choose a file type to export</option>
                <option value="1">csv</option>
            </select>
            <button id="button-export-file" type="button" class="btn btn-primary btn-sm" onclick="sendToExport()"
                style="margin-top: 10px;">Export</button>
        </div>
        <div style="margin-top: 20px;">
            <table class="table table-striped">
                <tbody>
                    {% for item in extracted_data %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td>{{ item }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    <script>
        function sendToExport() {
            let element = document.getElementById('select-export-file');
            let export_type = element.options[element.selectedIndex].value;
            let extracted_data = "{{ extracted_data|safe }}";

            fetch('/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json; charset=UTF-8', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ export_type, extracted_data })
            }).then(res => res.blob())
                .then(blob => downloadBlob(blob, `web-scraping-${Date.now()}.csv`))
                .catch(err => console.log);
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;

            const clickHandler = () => {
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    this.removeEventListener('click', clickHandler);
                }, 150);
            };

            a.addEventListener('click', clickHandler, false);
            a.click();
            return a;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

</body>

</html>